'use client'

import { useState } from 'react'
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from '@/components/ui/table'
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { MoreHorizontal, Pencil, Trash2, Search, ListTodo, User, Users } from 'lucide-react'
import { Badge } from '@/components/ui/badge'
import { ProjectDialog } from './project-dialog'
import { TaskDialog } from './task-dialog'
import { deleteProject } from '@/lib/actions/projects'
import { useRouter } from 'next/navigation'

interface Project {
    project_id: string
    project_name: string
    description: string | null
    start_date: string | null
    end_date: string | null
    status: string | null
    manager_name: string | null
    member_names: string[] | null
}

interface ProjectListProps {
    initialProjects: Project[]
}

export function ProjectList({ initialProjects }: ProjectListProps) {
    const router = useRouter()
    const [searchTerm, setSearchTerm] = useState('')
    const [statusFilter, setStatusFilter] = useState('all')
    const [isDialogOpen, setIsDialogOpen] = useState(false)
    const [isTaskDialogOpen, setIsTaskDialogOpen] = useState(false)
    const [editingProject, setEditingProject] = useState<Project | null>(null)
    const [selectedProjectId, setSelectedProjectId] = useState<string | null>(null)

    const filteredProjects = initialProjects.filter((project) => {
        const matchesSearch = project.project_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            project.project_id.toLowerCase().includes(searchTerm.toLowerCase())
        const matchesStatus = statusFilter === 'all' || project.status === statusFilter
        return matchesSearch && matchesStatus
    })

    const handleEdit = (project: Project) => {
        setEditingProject(project)
        setIsDialogOpen(true)
    }

    const handleManageTasks = (projectId: string) => {
        setSelectedProjectId(projectId)
        setIsTaskDialogOpen(true)
    }

    const handleDelete = async (projectId: string) => {
        if (confirm('Bạn có chắc chắn muốn xóa dự án này?')) {
            try {
                await deleteProject(projectId)
                router.refresh()
            } catch (error) {
                console.error('Error deleting project:', error)
                alert('Có lỗi xảy ra khi xóa dự án.')
            }
        }
    }

    const getStatusBadge = (status: string | null) => {
        switch (status) {
            case 'Đang thực hiện':
                return <Badge variant="secondary" className="bg-blue-500/10 text-blue-600 dark:text-blue-400 border-none">Đang thực hiện</Badge>
            case 'Hoàn thành':
                return <Badge variant="secondary" className="bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 border-none">Hoàn thành</Badge>
            case 'Tạm dừng':
                return <Badge variant="secondary" className="bg-amber-500/10 text-amber-600 dark:text-amber-400 border-none">Tạm dừng</Badge>
            case 'Hủy bỏ':
                return <Badge variant="destructive" className="border-none">Hủy bỏ</Badge>
            default:
                return <Badge variant="outline">{status}</Badge>
        }
    }

    return (
        <div className="space-y-4">
            <div className="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center">
                <div className="relative w-full md:max-w-sm">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="Tìm mã hoặc tên dự án..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="pl-10 h-10 rounded-xl"
                    />
                </div>
                <div className="flex items-center gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
                    <Button
                        variant={statusFilter === 'all' ? 'secondary' : 'ghost'}
                        size="sm"
                        onClick={() => setStatusFilter('all')}
                        className="rounded-full px-4"
                    >
                        Tất cả
                    </Button>
                    <Button
                        variant={statusFilter === 'Đang thực hiện' ? 'secondary' : 'ghost'}
                        size="sm"
                        onClick={() => setStatusFilter('Đang thực hiện')}
                        className="rounded-full px-4"
                    >
                        Đang thực hiện
                    </Button>
                    <Button
                        variant={statusFilter === 'Hoàn thành' ? 'secondary' : 'ghost'}
                        size="sm"
                        onClick={() => setStatusFilter('Hoàn thành')}
                        className="rounded-full px-4"
                    >
                        Hoàn thành
                    </Button>
                </div>
            </div>

            <div className="border border-border/50 rounded-xl overflow-hidden bg-card/40 backdrop-blur-xl shadow-sm">
                <Table>
                    <TableHeader>
                        <TableRow className="hover:bg-transparent border-border/50">
                            <TableHead className="w-[120px]">Mã dự án</TableHead>
                            <TableHead>Thông tin dự án</TableHead>
                            <TableHead>Người phụ trách</TableHead>
                            <TableHead>Trạng thái</TableHead>
                            <TableHead className="text-right">Thao tác</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {filteredProjects.length === 0 ? (
                            <TableRow>
                                <TableCell colSpan={5} className="h-24 text-center text-muted-foreground">
                                    Không tìm thấy dự án nào.
                                </TableCell>
                            </TableRow>
                        ) : (
                            filteredProjects.map((project) => (
                                <TableRow key={project.project_id} className="group hover:bg-foreground/[0.02] transition-colors border-border/50">
                                    <TableCell className="font-mono text-xs font-medium text-muted-foreground uppercase">{project.project_id}</TableCell>
                                    <TableCell>
                                        <div className="space-y-1">
                                            <p className="font-semibold text-foreground text-sm">{project.project_name}</p>
                                            <div className="flex items-center gap-3 text-[11px] text-muted-foreground">
                                                <span className="flex items-center gap-1">
                                                    {project.start_date || 'N/A'} - {project.end_date || 'N/A'}
                                                </span>
                                                <span className="flex items-center gap-1">
                                                    <Users className="h-3 w-3" />
                                                    {project.member_names?.length || 0}
                                                </span>
                                            </div>
                                        </div>
                                    </TableCell>
                                    <TableCell>
                                        {project.manager_name ? (
                                            <div className="flex items-center gap-2">
                                                <div className="h-6 w-6 rounded-full bg-primary/10 flex items-center justify-center">
                                                    <User className="h-3 w-3 text-primary" />
                                                </div>
                                                <span className="text-xs font-medium truncate max-w-[120px]" title={project.manager_name}>
                                                    {project.manager_name}
                                                </span>
                                            </div>
                                        ) : (
                                            <span className="text-xs text-muted-foreground italic">Chưa chỉ định</span>
                                        )}
                                    </TableCell>
                                    <TableCell>{getStatusBadge(project.status)}</TableCell>
                                    <TableCell className="text-right">
                                        <div className="flex items-center justify-end gap-1">
                                            <Button
                                                variant="ghost"
                                                size="sm"
                                                className="h-8 rounded-lg text-[11px] font-medium hover:bg-primary/10 hover:text-primary transition-colors"
                                                onClick={() => handleManageTasks(project.project_id)}
                                            >
                                                <ListTodo className="mr-1.5 h-3.5 w-3.5" />
                                                Công việc
                                            </Button>
                                            <DropdownMenu>
                                                <DropdownMenuTrigger asChild>
                                                    <Button variant="ghost" size="icon" className="h-8 w-8 rounded-lg">
                                                        <MoreHorizontal className="h-4 w-4" />
                                                    </Button>
                                                </DropdownMenuTrigger>
                                                <DropdownMenuContent align="end" className="w-[180px] rounded-xl p-1.5 backdrop-blur-xl bg-card/95">
                                                    <DropdownMenuItem onClick={() => handleEdit(project)} className="rounded-lg cursor-pointer">
                                                        <Pencil className="mr-2 h-4 w-4" />
                                                        <span className="text-sm">Chỉnh sửa dự án</span>
                                                    </DropdownMenuItem>
                                                    <DropdownMenuItem
                                                        onClick={() => handleDelete(project.project_id)}
                                                        className="rounded-lg text-destructive focus:text-destructive cursor-pointer"
                                                    >
                                                        <Trash2 className="mr-2 h-4 w-4" />
                                                        <span className="text-sm">Xóa dự án</span>
                                                    </DropdownMenuItem>
                                                </DropdownMenuContent>
                                            </DropdownMenu>
                                        </div>
                                    </TableCell>
                                </TableRow>
                            ))
                        )}
                    </TableBody>
                </Table>
            </div>

            <ProjectDialog
                open={isDialogOpen}
                onOpenChange={(open) => {
                    setIsDialogOpen(open)
                    if (!open) setEditingProject(null)
                }}
                project={editingProject}
                onSuccess={() => router.refresh()}
            />

            <TaskDialog
                open={isTaskDialogOpen}
                onOpenChange={setIsTaskDialogOpen}
                projectId={selectedProjectId || ''}
                onSuccess={() => router.refresh()}
            />
        </div>
    )
}
